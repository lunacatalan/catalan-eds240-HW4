# Read in libraries

```{r include = FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(janitor)
library(sf)
library(tidycensus)
library(patchwork)
```

# Questions

I plan to pursue the infographic option where I will be exploring affordable housing and housing needs in Los Angeles county. My initial thoughts are that the main image will be a map with the census tracts filled in with a variable. Possible variables include % of census tract by household that qualify for affordable housing, \# of households by tract that qualify for affordable housing, \# of individuals that qualify for affordable housing. Then, I want to zoom into specific tracts (eg. a tract with a high % of people that qualify for affordable housing and a tract with a low %) and compare the two by looking at vacancies in the tracts, affordable housing projects, or affordable housing units (though I haven't found this and it might be hard).\

My question has slightly changed to be more exploratory, however it could be used to explore how LA is doing at implementing the 2015 Executive Directive 13, Support for Affordable Housing (ED 13) aiming to help streamline the development of critical new housing developments that address our housing shortage. To really answer this question we would need a time series component. This could include looking at how the homelessness population in LA county has changed over time, as well as the number of affordable housing available (again, this data is really hard to come by which is why it was more interesting to look at vacancies as a proxy for available space that is maybe being kept off market even as the homeless population grows).\

Variables:\
- Number of vacancies in each tract from `tidycensus`\
- Total household income or Total individual income (over the last 12 months) weighted also from `tidycensus`. For this one, based on the household size, and the cap to qualify for affordable housing I am going to assign a new variable that identifies whether that individual qualifies or not (have not done this yet). I have a table from LAHD that has the income bins that decide whether households qualify or not.\
- Affordable housing developments dataset from [data.gov](https://catalog.data.gov/dataset/hcidla-affordable-housing-projects-list-2003-to-present) which I will wrangle and combine with homeless population data to see time series of number of affordable housing developments in LA county and homeless population over time.\
- Homeless population (over time? I don't have this data yet)\

Viz Inspo:\

I really like [this](https://www.christophenicault.com/media/visualizations/bigmac_index.png) visualization because it has a map with different elements coming out of it. I want to do something with a map and have specific census tracts zoomed in on to show different trends and give more data. I like that it is easy to compare the graphs from the different counties that are highlighted and see trends.\

I also really like the format of information for [this](https://gradientdescending.com/survivor-confessionals-data-dataset-showcase-for-survivor/) image. The image is broken up into 3 columns, and the visualizations in each are described by the slight text box above it. 

# Data

```{r}
# load list of variables that I could access
v17 <- load_variables(2020, "acs5", cache = TRUE)

vacancy_us <- read_csv(here::here("data", "ACS_Housing_Units_Vacancy_Status_Boundaries_-_Census_Tract.csv")) %>% 
  filter(NAME == "Census Tract 5336.03")

la_tract_vacant <- get_acs(
  state = "CA",
  county = "Los Angeles",
  geography = "tract",
  variables = "B25004_001",
  geometry = TRUE,
  year = 2020
)

neighborhood_census <- read_csv(here("data/Census_Data_by_Neighborhood_Council_20240201.csv")) %>%
  clean_names()

# Median income of districts
ca_county <- get_acs(
  state = "CA",
  county = "Los Angeles",
  geography = "county subdivision",
  variables = "B19013_001",
  geometry = TRUE,
  year = 2019
)

# join the census vacancy estimates with the census median income 
la_tract <- la_tract_tracts %>% 
  mutate(census_tract = gsub(", Los Angeles County, California", # elements that you want to remove
                                  "", # replace with blank
                                  NAME)) %>% 
  inner_join(vacancy_us) %>% 
  rename(median_income = estimate) %>% 
  select(-NAME)


pums_vars_2019 <- pums_variables %>% 
  filter(year == 2019, survey == "acs1")
```


```{r}
# Median income of tracts
la_tract_median_income <- get_acs(
  state = "CA",
  county = "Los Angeles",
  geography = "tract",
  variables = "B19013_001",
  geometry = TRUE,
  year = 2020
)

pums_total_income <- get_pums(state = "06",
                              survey = "acs1",
                              variables = c("PUMA", 
                                            "PINCP", #Total person's income (signed, use ADJINC to adjust to constant dollars)
                                            "NP", #	Number of persons in this household
                                            "HINCP", # Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars
                                            "GRPIP", #Gross rent as a percentage of household income past 12 months")
                                            "FINCP" # Family income (past 12 months, use ADJINC to adjust FINCP to constant dollars)
                                            ),
                              year = 2019)

# read in the geographies of the PUMA codes
html <- xml2::read_html("https://tigerweb.geo.census.gov/tigerwebmain/Files/tab20/tigerweb_tab20_puma_2020_us.html")
tables = rvest::html_table(html)
tables <- tables[[1]]

puma_la_geo <- tables %>% 
  filter(STATE == "6" & grepl(037, PUMA)) %>% 
  select(PUMA, BASENAME, POP100,
         HU100, # total number of households
         CENTLAT, CENTLON) %>% 
  mutate(PUMA = as.character(PUMA)) %>%  # to be able to join to income
  mutate(PUMA = stringr::str_pad(PUMA, # column 
                                 5, # number of characters
                                 pad = "0")) # what to add


# read in affordable housing projects in LA from 2003 to present
ah_raw <- read_csv(here("data/LAHD_Affordable_Housing_Projects_List__2003_to_Present__20240119.csv")) %>% 
  clean_names()

# homeless counts 2020
homeless_counts <- read_csv(here("data", "Homeless_Counts_2020.csv"))

# geometry of the puma shapefiles
puma <- read_sf(here("data", "tl_2019_06_puma10", "tl_2019_06_puma10.shp"))
```

## Wrangle and clean data

### Affordable housing project data
```{r}
# clean affordable housing data 
ah_clean <- ah_raw %>% 
  mutate(fun_date = as.Date(date_funded, tryFormats = c("%m/%d/%Y"))) %>% # make date_funded as date
  mutate(year = lubridate::year(fun_date)) %>% # make into year column 
  select(name, year, fun_date, construction_type, site_community, total_units = project_total_units, 
         housing_type, lahd_funded, in_service_date, gps_coords_on_map) %>% 
  mutate(gps_coords_on_map = gsub("[POINT()]", # elements that you want to remove
                                  "", # replace with blank
                                  gps_coords_on_map)) %>% # remove these elements from gps column 
  separate_wider_delim(gps_coords_on_map, 
                       delim = " ", names = c("empty", "coords"), # separate space from before the coordinates
                       too_many = "merge") %>% 
  separate_wider_delim(coords, delim = " ", names = c("Longitude", "Latitude"), # split lat and long coords
                       too_many = "merge") %>% 
  select(-empty) %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), # make into geometry object
                 crs = st_crs(ca_county)) %>% 
  st_join(ca_county) %>% 
  select(-c(GEOID, NAME, variable, moe)) %>%   # remove these column
  mutate(site_community = str_to_title(site_community))
  

# remove NC from the names
neighborhood_census$nc_name <- gsub(" NC", "", neighborhood_census$nc_name)

neighborhood_clean <- neighborhood_census %>% 
  select(nc_name, total_population, in_poverty, owner_occ, renter_occ) %>% 
  
  # replace character strings of left and convert to right
  mutate(nc_name = case_when(nc_name == "WESTLAKE NORTH" ~ "WESTLAKE",
                             nc_name == "CENTRAL HOLLYWOOD" ~ "HOLLYWOOD",
                             nc_name == "SOUTH CENTRAL" ~ "CENTRAL",
                             nc_name == "EAST HOLLYWOOD" ~ "HOLLYWOOD HILLS",
                             nc_name == "BEL AIR-BEVERLY CREST" ~ "CRESTVIEW",
                             nc_name == "WILSHIRE CENTER - KOREATOWN" ~ "KOREATOWN",
                             nc_name == "SUNLAND-TUJUNGA" ~ "SUNLAND",
                             nc_name == "ELYSIAN VALLEY RIVERSIDE" ~ "ELYSIAN VALLEY",
                             nc_name == "SILVER LAKE" ~ "SILVERLAKE",
                             nc_name == "UNITED NEIGHBORHOODS OF THE HISTORIC ARLINGTON HEIGHTS, WEST ADAMS, AND JEFFERSON PARK COMMUNITY" ~ "JEFFERSON PARK",
                             nc_name == "NORTH HILLS EAST" ~ "NORTH HILLS",
                             .default = as.character(nc_name))) %>% # keep all other cell values as are
  mutate(poverty_percent = (in_poverty/total_population)*100)  # make percentage of poverty

tract_neighborhood <- read_csv(here("data/Census_Tract_Locations__LA__20240206.csv")) %>% 
  mutate(census_tract = gsub(", Los Angeles County, California", # elements that you want to remove
                                  "", # replace with blank
                                  Tract)) %>% 
  select(-Tract, census_tract, Neighborhood, Latitude, Longitude) 

```

### Labeling individuals/households as qualifying for affordable housing 
```{r}

pums_total_income_la <- pums_total_income %>% 
  filter(grepl(037, PUMA)) %>% 
  inner_join(puma_la_geo) %>%
  st_as_sf(coords = c("CENTLON", "CENTLAT"), # make into geometry object
                 crs = st_crs(la_tract_median_income))
  # naniar::replace_with_na(replace = list(HINCP = -60000,
  #                                        FINCP = -60000,
  #                                        PINCP = -19999))

puma_tract <- la_tract_median_income %>% 
  st_join(pums_total_income_la, 
          join = st_intersects) %>% 
  mutate(NAME = gsub(", Los Angeles County, California", # elements that you want to remove
                             "", # replace with blank
                             NAME)) %>% 
  select(-c(variable, estimate, moe)) 
  #na.omit() # removed 2441 observations


plot(puma_la$geometry)
```

# Assigning income categories to individuals 
```{r}
puma_individual <- puma_tract %>% 
  select(NAME, SERIALNO, SPORDER, PWGTP, PINCP, PUMA) 

puma_household <- puma_tract %>% 
  select(NAME, SERIALNO, WGTP, NP, HINCP, FINCP, GRPIP, PUMA) %>% 
  mutate(status = ifelse(GRPIP < 30 ,
                         "not",
                         ifelse(GRPIP >= 30 & GRPIP < 50,
                                "cost_burden",
                                "severe_burden")))
  #distinct(SERIALNO, .keep_all = TRUE)

puma_la <- puma %>% 
  filter(grepl(037, PUMACE10)) %>% 
  rename(PUMA = PUMACE10)

pums_housing_income <- get_pums(state = "06",
                              survey = "acs1",
                              variables = c("PUMA",
                                            "NP", #	Number of persons in this household
                                            "HINCP", # Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars
                                            "GRPIP", #Gross rent as a percentage of household income past 12 months")
                                            "FINCP" # Family income (past 12 months, use ADJINC to adjust FINCP to constant dollars)
                                            ),
                              year = 2019)

# https://www.huduser.gov/portal/datasets/il/il2020/2020summary.odn
people <- c(1, 2, 3, 4, 5, 6, 7, 8)
very_low <- c(39450, 45050, 50700, 56300, 60850, 65350, 69850, 74350)
extreme_low <- c(23700, 27050, 30450, 33800, 36550, 39250, 41950, 44650)
low <- c(63100, 72100, 81100, 90100, 97350, 104550, 111750, 118950)

income_breaks <- data.frame(people, extreme_low, very_low, low)

puma_house_codes <- pums_housing_income %>% 
  select(SERIALNO, PUMA) %>% 
  distinct()

puma_h <- pums_housing_income %>% 
  inner_join(puma_la) %>% 
  select(SERIALNO, WGTP, NP, HINCP, FINCP, GRPIP) %>% 
  group_by(SERIALNO) %>% 
  summarize_all(mean) %>% 
  left_join(puma_house_codes)
  
```

```{r}
# very low income 
size <- seq(9, 20, 1)
very_low <- data.frame()
row_n <- data.frame()

for (i in seq_along(size)) {
  income <- 1.32 + (i*.08)
  limit <- income*56300
  row <- size[i]
  row_n <- rbind(row_n, row)
  very_low = rbind(very_low, limit)
}

very_low <- cbind(row_n, very_low) %>% 
  rename(people = X9,
         very_low = X78820)

extreme <- data.frame()
for (i in seq_along(size)) {
  # https://www.huduser.gov/portal/datasets/il/il2020/2020ILCalc3080.odn#calculator
  income <- 44120 + (i*4480)
  extreme <- rbind(extreme, income)
}

low <- data.frame()
for (i in seq_along(size)) {
  income <- 1.32 + (i*.08)
  limit <- income*90100
  low <- rbind(low, limit)
}

cols_9_20 <- cbind(extreme, very_low) %>% 
  rename(extreme_low = X48600) %>% 
  cbind(low) %>% 
  rename(low = X126140)

income_breaks <- rbind(income_breaks, cols_9_20)
```



```{r}

df_test <- slice_tail(puma_h, n = 10)
df_test$status <- rep(NA, nrow(df_test))

for (person in seq_along(df_test)) {
  
  individual <- df_test$NP[person]
  
  income <- income_breaks %>% 
    filter(people == individual)
  
  #print(individual)
  # Define thresholds for labels
  extreme_threshold <- income[[2]]
  very_low_threshold <- income[[3]]
  low_threshold <- income[[4]]
  
  print(extreme_threshold)
  # # Assign labels based on thresholds
  df_test$status[person] <- ifelse(df_test[["HINCP"]][person] <= extreme_threshold, 
                  "extreme",
                  ifelse(df_test[["HINCP"]][person] <= very_low_threshold & df_test[["HINCP"]][person] > extreme_threshold, 
                         "very low",
                         ifelse(df_test[["HINCP"]][person] <= low_threshold & df_test[["HINCP"]][person] > very_low_threshold, "low", 
                                "not eligible")))
}

puma_h$status <- rep(NA, nrow(puma_h))

for (person in 1:nrow(puma_h)) {
  
  individual <- puma_h$NP[person]
  
  income <- income_breaks %>% 
    filter(people == individual)
  
  #print(individual)
  #print(individual)
  # Define thresholds for labels
  extreme_threshold <- income[[2]]
  very_low_threshold <- income[[3]]
  low_threshold <- income[[4]]
  
  # # Assign labels based on thresholds
  puma_h$status[person] <- ifelse(puma_h[["HINCP"]][person] <= extreme_threshold, 
                              "extreme",
                              ifelse(puma_h[["HINCP"]][person] > extreme_threshold & puma_h[["HINCP"]][person] <= very_low_threshold, 
                                     "very low",
                                     ifelse(puma_h[["HINCP"]][person] > very_low_threshold & puma_h[["HINCP"]][person] <= low_threshold, 
                                            "low",
                                            ifelse(puma_h[["HINCP"]][person] > low_threshold, "not eligible", "non"))))
}

```

```{r fig.width = 11, fig.height = 14}

puma_geo <- puma_la %>% 
  select(PUMA, geometry)


puma_plot <- puma_h %>% 
  group_by(PUMA) %>% 
  count(status) %>% 
  pivot_wider(names_from = "status", values_from = "n") %>% 
  ungroup() %>% 
  clean_names() %>% 
  select(puma, extreme, very_low, low, not_eligible) %>% 
  mutate(PUMA = puma, 
         total_households = rowSums(.[2:5]),
         total_eligible = rowSums(.[2:4]),
         percent_eligible = (total_eligible/total_households) * 100 ) %>% 
  left_join(puma_geo) %>% 
  st_as_sf()

my_brew_palette10 <- RColorBrewer::brewer.pal(n = 10, name = 'PuRd')


ggplot(puma_plot) +
  geom_sf(aes(fill = percent_eligible)) +
  scale_fill_stepsn(colors = my_brew_palette10,
                    labels = scales::label_percent(scale = 1),
                    breaks = scales::breaks_width(width = 10)) +
  theme_minimal() +
  labs(title = "Households Eligible for Affordable Housing by PUMA in Los Angeles, CA",
       fill = "Percent Eligible") +
  theme(
    axis.text = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.margin = margin(12, 6, 12, 18),
    panel.background = element_rect(fill = "white", colour = NA),
    title = element_text(hjust = )
  ) +
  guides(fill = guide_colorbar(barheight = unit(1, units = "mm"),  
                                 barwidth = unit(100, units = "mm"),
                                 direction = "horizontal",
                                 ticks.colour = "grey20",
                                 title.position = "top",
                                 label.position = "bottom",
                                 title.hjust = 0.5))


```


```{r}
puma_tract_codes <- read_csv("https://www2.census.gov/geo/docs/maps-data/data/rel2020/2020_Census_Tract_to_2020_PUMA.txt")

codes_la <- puma_tract_codes %>% 
  filter(STATEFP == "06" & COUNTYFP == "037") %>%  # California state code & Los Angeles county code
  select(-c(STATEFP, COUNTYFP)) %>% 
  rename(PUMA = PUMA5CE)
```


### Joining together the pums data with census and neighborhood data 
```{r}

pums_neighborhood <- pums_total_income_la %>% 
  left_join(codes_la, by = "PUMA")

```

