# Read in libraries

```{r include = FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(janitor)
library(sf)
library(tidycensus)
library(patchwork)
```

# Questions

I plan to pursue the infographic option where I will be exploring affordable housing and housing needs in Los Angeles county. My initial thoughts are that the main image will be a map with the census tracts filled in with a variable. Possible variables include % of census tract by household that qualify for affordable housing, \# of households by tract that qualify for affordable housing, \# of individuals that qualify for affordable housing. Then, I want to zoom into specific tracts (eg. a tract with a high % of people that qualify for affordable housing and a tract with a low %) and compare the two by looking at vacancies in the tracts, affordable housing projects, or affordable housing units (though I haven't found this and it might be hard).\

My question has slightly changed to be more exploratory, however it could be used to explore how LA is doing at implementing the 2015 Executive Directive 13, Support for Affordable Housing (ED 13) aiming to help streamline the development of critical new housing developments that address our housing shortage. To really answer this question we would need a time series component. This could include looking at how the homelessness population in LA county has changed over time, as well as the number of affordable housing available (again, this data is really hard to come by which is why it was more interesting to look at vacancies as a proxy for available space that is maybe being kept off market even as the homeless population grows).\

Variables:\
- Number of vacancies in each tract from `tidycensus`\
- Total household income or Total individual income (over the last 12 months) weighted also from `tidycensus`. For this one, based on the household size, and the cap to qualify for affordable housing I am going to assign a new variable that identifies whether that individual qualifies or not (have not done this yet). I have a table from LAHD that has the income bins that decide whether households qualify or not.\
- Affordable housing developments dataset from [data.gov](https://catalog.data.gov/dataset/hcidla-affordable-housing-projects-list-2003-to-present) which I will wrangle and combine with homeless population data to see time series of number of affordable housing developments in LA county and homeless population over time.\
- Homeless population (over time? I don't have this data yet)\

Viz Inspo:\

I really like [this](https://www.christophenicault.com/media/visualizations/bigmac_index.png) visualization because it has a map with different elements coming out of it. I want to do something with a map and have specific census tracts zoomed in on to show different trends and give more data. I like that it is easy to compare the graphs from the different counties that are highlighted and see trends.\

I also really like the format of information for [this](https://gradientdescending.com/survivor-confessionals-data-dataset-showcase-for-survivor/) image. The image is broken up into 3 columns, and the visualizations in each are described by the slight text box above it. 

# Data

## Wrangle and Clean Data

```{r}
# geometry of the puma shapefiles
puma <- read_sf(here("data", "tl_2019_06_puma10", "tl_2019_06_puma10.shp"))

puma_la <- puma %>% 
  filter(grepl(037, PUMACE10)) %>% 
  rename(PUMA = PUMACE10)

pums_housing_income <- get_pums(state = "06",
                              survey = "acs1",
                              variables = c("PUMA",
                                            "NP", #	Number of persons in this household
                                            "HINCP", # Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars
                                            "GRPIP", #Gross rent as a percentage of household income past 12 months")
                                            "FINCP" # Family income (past 12 months, use ADJINC to adjust FINCP to constant dollars)
                                            ),
                              year = 2019)

# https://www.huduser.gov/portal/datasets/il/il2020/2020summary.odn
people <- c(1, 2, 3, 4, 5, 6, 7, 8)
very_low <- c(39450, 45050, 50700, 56300, 60850, 65350, 69850, 74350)
extreme_low <- c(23700, 27050, 30450, 33800, 36550, 39250, 41950, 44650)
low <- c(63100, 72100, 81100, 90100, 97350, 104550, 111750, 118950)

income_breaks <- data.frame(people, extreme_low, very_low, low)

# remove the duplicates 
puma_house_codes <- pums_housing_income %>% 
  select(SERIALNO, PUMA) %>% 
  distinct()

puma_h <- pums_housing_income %>% 
  inner_join(puma_la) %>% 
  select(SERIALNO, WGTP, NP, HINCP, FINCP, GRPIP) %>% 
  group_by(SERIALNO) %>% 
  summarize_all(mean) %>% 
  left_join(puma_house_codes)
  
```

## Assigning income categories to households 

### Create income breaks for households above 8 (from 9-20)
```{r}
# very low income 
size <- seq(9, 20, 1)
very_low <- data.frame()
row_n <- data.frame()

for (i in seq_along(size)) {
  income <- 1.32 + (i*.08)
  limit <- income*56300
  row <- size[i]
  row_n <- rbind(row_n, row)
  very_low = rbind(very_low, limit)
}

very_low <- cbind(row_n, very_low) %>% 
  rename(people = X9,
         very_low = X78820)

extreme <- data.frame()
for (i in seq_along(size)) {
  # https://www.huduser.gov/portal/datasets/il/il2020/2020ILCalc3080.odn#calculator
  income <- 44120 + (i*4480)
  extreme <- rbind(extreme, income)
}

low <- data.frame()
for (i in seq_along(size)) {
  income <- 1.32 + (i*.08)
  limit <- income*90100
  low <- rbind(low, limit)
}

cols_9_20 <- cbind(extreme, very_low) %>% 
  rename(extreme_low = X48600) %>% 
  cbind(low) %>% 
  rename(low = X126140)

income_breaks <- rbind(income_breaks, cols_9_20)
```


## Creating For Loop

### Testing for loop on subset of dataset
```{r, eval = FALSE}
df_test <- slice_tail(puma_h, n = 10)
df_test$status <- rep(NA, nrow(df_test))

for (person in seq_along(df_test)) {
  
  individual <- df_test$NP[person]
  
  income <- income_breaks %>% 
    filter(people == individual)
  
  #print(individual)
  # Define thresholds for labels
  extreme_threshold <- income[[2]]
  very_low_threshold <- income[[3]]
  low_threshold <- income[[4]]
  
  print(extreme_threshold)
  # # Assign labels based on thresholds
  df_test$status[person] <- ifelse(df_test[["HINCP"]][person] <= extreme_threshold, 
                  "extreme",
                  ifelse(df_test[["HINCP"]][person] <= very_low_threshold & df_test[["HINCP"]][person] > extreme_threshold, 
                         "very low",
                         ifelse(df_test[["HINCP"]][person] <= low_threshold & df_test[["HINCP"]][person] > very_low_threshold, "low", 
                                "not eligible")))
}
```

### Applying for loop to the whole data set
```{r}
puma_h$status <- rep(NA, nrow(puma_h))

for (person in 1:nrow(puma_h)) {
  
  individual <- puma_h$NP[person]
  
  income <- income_breaks %>% 
    filter(people == individual)
  
  #print(individual)
  #print(individual)
  # Define thresholds for labels
  extreme_threshold <- income[[2]]
  very_low_threshold <- income[[3]]
  low_threshold <- income[[4]]
  
  # # Assign labels based on thresholds
  puma_h$status[person] <- ifelse(puma_h[["HINCP"]][person] <= extreme_threshold, 
                              "extreme",
                              ifelse(puma_h[["HINCP"]][person] > extreme_threshold & puma_h[["HINCP"]][person] <= very_low_threshold, 
                                     "very low",
                                     ifelse(puma_h[["HINCP"]][person] > very_low_threshold & puma_h[["HINCP"]][person] <= low_threshold, 
                                            "low",
                                            ifelse(puma_h[["HINCP"]][person] > low_threshold, "not eligible", "non"))))
}

```


```{r}
puma_geo <- puma_la %>% 
  select(PUMA, geometry)


puma_plot <- puma_h %>% 
  group_by(PUMA) %>% 
  count(status) %>% 
  pivot_wider(names_from = "status", values_from = "n") %>% 
  ungroup() %>% 
  clean_names() %>% 
  select(puma, extreme, very_low, low, not_eligible) %>% 
  mutate(PUMA = puma, 
         total_households = rowSums(.[2:5]),
         total_eligible = rowSums(.[2:4]),
         percent_eligible = (total_eligible/total_households) * 100 ) %>% 
  left_join(puma_geo) %>% 
  st_as_sf()
```


```{r fig.width = 11, fig.height = 14}

title <- "Households Eligible for Affordable Housing by PUMA in Los Angeles, CA"
subtitle <- str_wrap(
  "Percent of people that qualify for affordabl housing", 180)


my_brew_palette10 <- RColorBrewer::brewer.pal(n = 10, name = 'PuRd')


ggplot(puma_plot) +
  geom_sf(aes(fill = percent_eligible)) +
  scale_fill_stepsn(colors = my_brew_palette10,
                    labels = scales::label_percent(scale = 1),
                    breaks = scales::breaks_width(width = 10)) +
  theme_minimal() +
  labs(title = "Households Eligible for Affordable Housing by PUMA in Los Angeles, CA",
       fill = "Percent Eligible") +
  theme(
    axis.text = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    plot.margin = margin(12, 6, 12, 18),
    panel.background = element_rect(fill = "white", colour = NA),
    title = element_text(hjust = )
  ) +
  guides(fill = guide_colorbar(barheight = unit(1, units = "mm"),  
                                 barwidth = unit(100, units = "mm"),
                                 direction = "horizontal",
                                 ticks.colour = "grey20",
                                 title.position = "top",
                                 label.position = "bottom",
                                 title.hjust = 0.5))


```
